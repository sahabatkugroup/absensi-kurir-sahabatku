<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sahabatku Delivery ‚Äî Terhubung Firebase</title>
  <style>
    :root{--bg:#f7fafc;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--line:#e5e7eb;--brand:#0b4870;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:980px;margin:0 auto;padding:24px}
    h1{font-size:22px;margin:0 0 18px;color:var(--brand)}
    h2{font-size:18px;margin:18px 0 10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    input,button{font:inherit}
    input{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    label{font-size:12px;color:var(--muted)}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:640px){.grid-2{grid-template-columns:1fr}}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{padding:10px 14px;border:1px solid var(--line);background:#fff;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .list{display:grid;gap:10px;margin-top:12px}
    .nota{border:1px solid var(--line);border-radius:10px;padding:12px;background:#fff}
    .muted{color:var(--muted);font-size:12px}
    .hidden{display:none}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef6ff;color:#0b4870;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üõµ Sahabatku Delivery <span class="pill">Firebase Realtime Database</span></h1>

    <!-- LOGIN -->
    <div id="loginPage" class="card">
      <h2>Masuk</h2>
      <div class="grid grid-2">
        <div>
          <label>Username</label>
          <input id="username" placeholder="mis. admin / budi"/>
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn primary" onclick="doLogin()">Masuk</button>
        <span id="loginError" class="muted"></span>
      </div>
      <div class="muted" style="margin-top:8px">Contoh akun: <b>admin/12345</b> atau <b>budi/budi123</b></div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="row" style="align-items:center;justify-content:space-between;margin:12px 0">
        <div class="muted">Masuk sebagai <b id="curUser"></b></div>
        <button class="btn" onclick="logout()">Keluar</button>
      </div>

      <div class="card">
        <h2 id="formStatus">üÜï Mode Tambah Nota</h2>
        <div class="grid grid-2">
          <div>
            <label>Nama Customer</label>
            <input id="custName" placeholder="Nama pelanggan"/>
          </div>
          <div>
            <label>No. HP</label>
            <input id="custPhone" placeholder="08xxxx" />
          </div>
          <div>
            <label>Ongkir (Rp)</label>
            <input id="ongkir" type="number" placeholder="0"/>
          </div>
        </div>

        <h3 style="margin-top:16px">Items</h3>
        <div id="itemsArea" class="grid"></div>
        <button class="btn" type="button" onclick="tambahItem()">+ Tambah Item</button>

        <h3 style="margin-top:16px">Tambahan</h3>
        <div id="tambahanArea" class="grid"></div>
        <button class="btn" type="button" onclick="tambahTambahan()">+ Tambahan</button>

        <div class="toolbar">
          <button id="saveBtn" class="btn primary" type="button" onclick="tambahNota()">üíæ Simpan Nota</button>
          <button class="btn" type="button" onclick="batalEdit()">‚Ü©Ô∏è Batal Edit</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>Daftar Nota</h2>
        <div id="notaList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Firebase + App Script -->
  <script type="module">
    // Firebase CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
    import { getDatabase, ref, set, push, update, get, child, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // === KONFIGURASI PROYEK KAMU ===
    const firebaseConfig = {
      apiKey: "AIzaSyCtva8TeL40-WotK4kFL_vL8uUXL3GDfww",
      authDomain: "sahabatkuu-bisa.firebaseapp.com",
      databaseURL: "https://sahabatkuu-bisa-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "sahabatkuu-bisa",
      storageBucket: "sahabatkuu-bisa.appspot.com",
      messagingSenderId: "315555564115",
      appId: "1:315555564115:web:56f46dbceb8c154589d4a6",
      measurementId: "G-PFGYL96VPS"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    // ====== STATE ======
    let loggedUser = null;
    let editingNotaId = null;

    // ====== AUTH SEDERHANA (DEMO) ======
    const users = { admin:{password:"12345"}, budi:{password:"budi123"} };

    window.doLogin = function doLogin(){
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      if(users[user]?.password === pass){
        loggedUser = user;
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('curUser').innerText = loggedUser;
        resetForm();
        loadNota();
        enableAutoSaveForm();
        restoreDraftIfAny();
      }else{
        document.getElementById('loginError').innerText = "Username atau password salah";
      }
    };

    window.logout = function logout(){
      loggedUser = null;
      document.getElementById('app').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('username').value = "";
      document.getElementById('password').value = "";
    };

    // ====== FORM HELPERS ======
    function resetForm(){
      document.getElementById("custName").value = "";
      document.getElementById("custPhone").value = "";
      document.getElementById("ongkir").value = "";
      document.getElementById("itemsArea").innerHTML = "";
      document.getElementById("tambahanArea").innerHTML = "";
      document.getElementById("formStatus").innerText = "üÜï Mode Tambah Nota";
      document.getElementById("saveBtn").innerText = "üíæ Simpan Nota";
      editingNotaId = null;
      document.getElementById("custName").focus();
      // hapus draft
      localStorage.removeItem(getDraftKey());
    }

    window.tambahItem = function(){
      const wrap = document.createElement('div');
      wrap.className = 'grid grid-2';
      wrap.innerHTML = `
        <input placeholder="Nama item" />
        <input type="number" placeholder="Qty" />
      `;
      document.getElementById('itemsArea').appendChild(wrap);
    };

    window.tambahTambahan = function(){
      const wrap = document.createElement('div');
      wrap.className = 'grid grid-2';
      wrap.innerHTML = `
        <input placeholder="Keterangan" />
        <input type="number" placeholder="Biaya" />
      `;
      document.getElementById('tambahanArea').appendChild(wrap);
    };

    // ====== DRAFT (AUTO-SAVE) ======
    function getDraftKey(){ return "draft_nota_" + (loggedUser ?? "guest"); }

    function gatherFormDraft(){
      return {
        custName: document.getElementById("custName").value,
        custPhone: document.getElementById("custPhone").value,
        ongkir: document.getElementById("ongkir").value,
        items: Array.from(document.querySelectorAll('#itemsArea .grid input:nth-child(1)')).map((el,i)=>{
          const qty = document.querySelectorAll('#itemsArea .grid input:nth-child(2)')[i];
          return { name: el.value, qty: qty?.value ?? "" };
        }),
        tambahan: Array.from(document.querySelectorAll('#tambahanArea .grid input:nth-child(1)')).map((el,i)=>{
          const biaya = document.querySelectorAll('#tambahanArea .grid input:nth-child(2)')[i];
          return { ket: el.value, biaya: biaya?.value ?? "" };
        })
      };
    }

    function restoreDraftIfAny(){
      const raw = localStorage.getItem(getDraftKey());
      if(!raw) return;
      try{
        const d = JSON.parse(raw);
        document.getElementById("custName").value = d.custName || "";
        document.getElementById("custPhone").value = d.custPhone || "";
        document.getElementById("ongkir").value = d.ongkir || "";
        (d.items||[]).forEach(it=>{
          window.tambahItem();
          const blocks = document.querySelectorAll('#itemsArea .grid');
          const last = blocks[blocks.length-1];
          last.querySelector('input:nth-child(1)').value = it.name || "";
          last.querySelector('input:nth-child(2)').value = it.qty || "";
        });
        (d.tambahan||[]).forEach(t=>{
          window.tambahTambahan();
          const blocks = document.querySelectorAll('#tambahanArea .grid');
          const last = blocks[blocks.length-1];
          last.querySelector('input:nth-child(1)').value = t.ket || "";
          last.querySelector('input:nth-child(2)').value = t.biaya || "";
        });
      }catch{}
    }

    function enableAutoSaveForm(){
      const selector = '#custName, #custPhone, #ongkir, #itemsArea input, #tambahanArea input';
      document.addEventListener('input', (e)=>{
        if(!(e.target instanceof HTMLInputElement)) return;
        if(!e.target.matches(selector)) return;
        const draft = gatherFormDraft();
        localStorage.setItem(getDraftKey(), JSON.stringify(draft));
      });
    }

    // ====== CRUD NOTA ======
    window.tambahNota = function(){
      if(!loggedUser){ alert("Harus login"); return; }
      const nota = {
        pelanggan: document.getElementById("custName").value.trim(),
        telp: document.getElementById("custPhone").value.trim(),
        ongkir: Number(document.getElementById("ongkir").value || 0),
        items: Array.from(document.querySelectorAll('#itemsArea .grid')).map(g=>{
          const [n,q] = g.querySelectorAll('input');
          return { name: n.value.trim(), qty: Number(q.value || 0) };
        }),
        tambahan: Array.from(document.querySelectorAll('#tambahanArea .grid')).map(g=>{
          const [k,b] = g.querySelectorAll('input');
          return { ket: k.value.trim(), biaya: Number(b.value || 0) };
        }),
        timestamp: Date.now()
      };

      if(editingNotaId){
        const upRef = ref(db, `nota/${loggedUser}/${editingNotaId}`);
        update(upRef, nota).then(()=>{
          alert("‚úèÔ∏è Nota diperbarui");
          resetForm();
          loadNota();
        }).catch(err=>alert("Gagal update: " + err.message));
      }else{
        const newRef = push(ref(db, `nota/${loggedUser}`));
        set(newRef, nota).then(()=>{
          alert("‚úÖ Nota disimpan");
          resetForm();
          loadNota();
        }).catch(err=>alert("Gagal simpan: " + err.message));
      }
    };

    function renderList(data){
      const list = document.getElementById('notaList');
      list.innerHTML = "";
      if(!data){ list.innerHTML = '<div class="muted">Belum ada nota.</div>'; return; }
      const entries = Object.entries(data).sort((a,b)=>b[1].timestamp - a[1].timestamp);
      for(const [id, n] of entries){
        const el = document.createElement('div');
        el.className = 'nota';
        const d = new Date(n.timestamp);
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
            <div>
              <div><b>${n.pelanggan || '-'}</b> <span class="muted">(${n.telp || '-'})</span></div>
              <div class="muted">${d.toLocaleString('id-ID')}</div>
              <div class="muted">Ongkir: Rp${(n.ongkir||0).toLocaleString('id-ID')}</div>
            </div>
            <div class="row">
              <button class="btn" onclick='editNota(${JSON.stringify(id)},{pelanggan:${JSON.stringify(n.pelanggan)},telp:${JSON.stringify(n.telp)},ongkir:${JSON.stringify(n.ongkir)},items:${JSON.stringify(n.items||[])},tambahan:${JSON.stringify(n.tambahan||[])}})'>‚úèÔ∏è Edit</button>
              <button class="btn danger" onclick="hapusNota(${JSON.stringify(id)})">üóëÔ∏è Hapus</button>
            </div>
          </div>
        `;
        list.appendChild(el);
      }
    }

    function loadNota(){
      const dbRef = ref(db);
      get(child(dbRef, `nota/${loggedUser}`)).then(snap=>{
        renderList(snap.exists() ? snap.val() : null);
      }).catch(err=>{
        alert("Gagal load: " + err.message);
      });
    }

    window.editNota = function(id, nota){
      editingNotaId = id;
      document.getElementById("custName").value = nota.pelanggan || "";
      document.getElementById("custPhone").value = nota.telp || "";
      document.getElementById("ongkir").value = nota.ongkir ?? "";
      document.getElementById("itemsArea").innerHTML = "";
      (nota.items||[]).forEach(it=>{
        window.tambahItem();
        const blocks = document.querySelectorAll('#itemsArea .grid');
        const last = blocks[blocks.length-1];
        last.querySelector('input:nth-child(1)').value = it.name || "";
        last.querySelector('input:nth-child(2)').value = it.qty ?? "";
      });
      document.getElementById("tambahanArea").innerHTML = "";
      (nota.tambahan||[]).forEach(t=>{
        window.tambahTambahan();
        const blocks = document.querySelectorAll('#tambahanArea .grid');
        const last = blocks[blocks.length-1];
        last.querySelector('input:nth-child(1)').value = t.ket || "";
        last.querySelector('input:nth-child(2)').value = t.biaya ?? "";
      });

      document.getElementById("formStatus").innerText = "‚úèÔ∏è Mode Edit Nota";
      document.getElementById("saveBtn").innerText = "‚úèÔ∏è Update Nota";
      document.getElementById("custName").focus();

      // simpan draft edit biar aman
      const draft = gatherFormDraft();
      localStorage.setItem(getDraftKey(), JSON.stringify(draft));
    };

    window.batalEdit = function(){
      resetForm();
      alert("‚ùå Edit dibatalkan");
    };

    window.hapusNota = function(id){
      if(!confirm("Yakin hapus nota ini?")) return;
      const delRef = ref(db, `nota/${loggedUser}/${id}`);
      remove(delRef).then(()=>{
        loadNota();
      }).catch(err=>alert("Gagal hapus: " + err.message));
    };

    // ====== SHORTCUT ENTER ======
    document.addEventListener("DOMContentLoaded", ()=>{
      const custPhone = document.getElementById("custPhone");
      const ongkir = document.getElementById("ongkir");

      custPhone.addEventListener("keydown",(e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          ongkir.focus();
        }
      });

      ongkir.addEventListener("keydown",(e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          window.tambahItem();
          document.querySelector("#itemsArea .grid input")?.focus();
        }
      });
    });
  </script>
</body>
</html>
